#!/bin/bash

main () {
    set -eo pipefail
    declare desc="Script used to generate version tag for bookmartian container."

    # script variables
    local current_build_number=0
    local maven_version="0.0.0"
    local full_tag="0.0.0.0"
    local username="$USER"

    # use a local file to store and increment a build id
    local filename=~/bookmartian.buildid

    if [ -f "$filename" ]; then
        current_build_number="$(cat "$filename")"
        let current_build_number="$current_build_number"+1
    fi

    maven_version="$(mvn org.apache.maven.plugins:maven-help-plugin:3.2.0:evaluate -Dexpression='project.version' -q -DforceStdout)"
    full_tag="$(printf "%s.%s-%s" $maven_version $current_build_number $username)"
    
    # write an incremented build id to the file for next time
    echo "$current_build_number" > "$filename"

    # send the full string to stdout
    echo "$full_tag"

    }

main "$@"

# bash script written using best practices from https://github.com/progrium/bashstyle